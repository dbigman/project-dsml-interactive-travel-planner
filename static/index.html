<!DOCTYPE html>
<html lang="en">
<head>
    <title>Puerto Rico Travel Planner</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh; /* Full screen height */
        }

        /* Left side: Map */
        #map-container {
            width: 50%;
            height: 100vh;
        }

        /* Right side: User Inputs */
        #controls {
            width: 50%;
            padding: 20px;
            overflow-y: auto;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        h2 {
            margin-top: 0;
        }

        #travel-info {
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }

        ul {
            list-style: none;
            padding: 0;
        }

        li {
            padding: 5px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        select, button {
            width: 100%;
            padding: 10px;
            margin-top: 10px;
            font-size: 16px;
        }

        .remove-btn {
            background-color: red;
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD-ZmWiClcv1g_QJgI96CslsgeW-QcXLLQ&callback=initMap" async defer></script>
</head>
<body>
    
    <!-- Left Side: Map -->
    <div id="map-container">
        <div id="map" style="width:100%; height:100%;"></div>
    </div>

    <!-- Right Side: Controls -->
    <div id="controls">
        <h2>Puerto Rico Travel Planner</h2>

        <!-- Checkboxes to toggle visibility -->
        <label><input type="checkbox" id="toggleLandmarks" checked> Show Landmarks</label>
        <label><input type="checkbox" id="toggleMunicipalities" checked> Show Municipalities</label>

        <!-- Dropdowns for route selection -->
        <label for="start">Start:</label>
        <select id="start"></select>

        <label for="waypoints">Waypoints (Stops):</label>
        <select id="waypoints"></select>
        <button onclick="addWaypoint()">Add Stop</button>

        <ul id="waypoint-list"></ul> <!-- Waypoints List -->

        <label for="end">Destination:</label>
        <select id="end"></select>

        <button onclick="calculateRoute()">Get Route</button>

        <div id="travel-info"></div> <!-- Travel Time & Distance -->

        <h3>Turn-by-Turn Directions</h3>
        <ul id="directions-list"></ul> <!-- Directions List -->
    </div>

    <script>
        let map;
        let directionsService;
        let directionsRenderer;
        let landmarkMarkers = [];
        let municipalityMarkers = [];
        let locations = [];
        let waypoints = []; // Stores user-selected waypoints

        function initMap() {
            map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: { lat: 18.2208, lng: -66.5901 }
            });

            directionsService = new google.maps.DirectionsService();
            directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
            directionsRenderer.setMap(map);

            fetch('/get_locations')
                .then(response => response.json())
                .then(data => {
                    if (!data.landmarks || !data.municipalities) {
                        console.error("Invalid data format:", data);
                        return;
                    }

                    locations = [...data.landmarks, ...data.municipalities]; // Combine for dropdowns
                    populateDropdowns(locations);

                    createMarkers(data.landmarks, "http://maps.google.com/mapfiles/ms/icons/blue-dot.png", landmarkMarkers);
                    createMarkers(data.municipalities, "http://maps.google.com/mapfiles/ms/icons/red-dot.png", municipalityMarkers);
                })
                .catch(error => console.error("Error fetching locations:", error));

            document.getElementById("toggleLandmarks").addEventListener("change", toggleMarkers);
            document.getElementById("toggleMunicipalities").addEventListener("change", toggleMarkers);
        }

        function createMarkers(locations, icon, markerArray) {
            locations.forEach(location => {
                let marker = new google.maps.Marker({
                    position: { lat: location.lat, lng: location.lng },
                    map: map,
                    title: location.name,
                    icon: icon
                });
                markerArray.push(marker);
            });
        }

        function toggleMarkers() {
            let showLandmarks = document.getElementById("toggleLandmarks").checked;
            let showMunicipalities = document.getElementById("toggleMunicipalities").checked;

            landmarkMarkers.forEach(marker => marker.setMap(showLandmarks ? map : null));
            municipalityMarkers.forEach(marker => marker.setMap(showMunicipalities ? map : null));
        }

        function populateDropdowns(locations) {
            let startDropdown = document.getElementById("start");
            let endDropdown = document.getElementById("end");
            let waypointsDropdown = document.getElementById("waypoints");

            locations.forEach(location => {
                let option = new Option(location.name, JSON.stringify({lat: location.lat, lng: location.lng}));
                startDropdown.add(option.cloneNode(true));
                endDropdown.add(option.cloneNode(true));
                waypointsDropdown.add(option);
            });
        }

        function addWaypoint() {
            let waypoint = JSON.parse(document.getElementById("waypoints").value);
            let waypointName = document.getElementById("waypoints").selectedOptions[0].text;

            if (!waypoint || waypoints.length >= 8) {
                alert("You can add up to 8 waypoints.");
                return;
            }

            waypoints.push(waypoint);

            let waypointList = document.getElementById("waypoint-list");
            let listItem = document.createElement("li");
            listItem.innerHTML = `${waypointName} <button class="remove-btn" onclick="removeWaypoint(${waypoints.length - 1})">X</button>`;
            waypointList.appendChild(listItem);
        }

        function removeWaypoint(index) {
            waypoints.splice(index, 1);
            document.getElementById("waypoint-list").innerHTML = "";
            waypoints.forEach((wp, i) => addWaypoint(wp, i)); // Rebuild list
        }

        function calculateRoute() {
            let start = JSON.parse(document.getElementById("start").value);
            let end = JSON.parse(document.getElementById("end").value);

            if (!start || !end) {
                alert("Please select a start and destination.");
                return;
            }

            let request = {
                origin: new google.maps.LatLng(start.lat, start.lng),
                destination: new google.maps.LatLng(end.lat, end.lng),
                waypoints: waypoints.map(wp => ({ location: new google.maps.LatLng(wp.lat, wp.lng), stopover: true })),
                optimizeWaypoints: true,
                travelMode: google.maps.TravelMode.DRIVING
            };

            directionsService.route(request, function(result, status) {
                if (status === google.maps.DirectionsStatus.OK) {
                    directionsRenderer.setDirections(result);
                } else {
                    alert("Could not calculate route.");
                }
            });
        }
    </script>

</body>
</html>
